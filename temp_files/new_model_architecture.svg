<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1800" height="2400" viewBox="0 0 1800 2400">
  <style>
    .bg {fill: #f8f9fa; }
    .box {fill: #ffffff; stroke: #333; stroke-width: 2; rx: 6; }
    .input {fill: #d1e7f0; stroke: #2980b9; stroke-width: 2; rx: 6; }
    .feature {fill: #e1f5e1; stroke: #27ae60; stroke-width: 2; rx: 6; }
    .attn {fill: #fadbd8; stroke: #e74c3c; stroke-width: 2; rx: 6; }
    .fusion {fill: #f8d9f2; stroke: #8e44ad; stroke-width: 2; rx: 6; }
    .output {fill: #fff9db; stroke: #f39c12; stroke-width: 2; rx: 6; }
    .mem {fill: #e8daef; stroke: #8e44ad; stroke-width: 2; rx: 6; stroke-dasharray: 4,2; }
    .diff {fill: #feeaea; stroke: #c0392b; stroke-width: 2.5; rx: 6; }
    .highlight {fill: none; stroke: #e74c3c; stroke-width: 3; rx: 8; }
    .process {fill: #eafaf1; stroke: #27ae60; stroke-width: 2; rx: 6; }
    .fpn {fill: #fff8dc; stroke: #d4ac0d; stroke-width: 2; rx: 6; }
    .arrow {stroke: #666; stroke-width: 2; marker-end: url(#arrow); fill: none; }
    .dashed-arrow {stroke: #666; stroke-width: 2; stroke-dasharray: 5,5; marker-end: url(#arrow); fill: none; }
    .highlight-arrow {stroke: #e74c3c; stroke-width: 2.5; marker-end: url(#redarrow); fill: none; }
    .lateral-arrow {stroke: #d4ac0d; stroke-width: 2.5; stroke-dasharray: 3,3; marker-end: url(#goldarrow); fill: none; }
    .label {font-family: Arial; font-size: 14px; text-anchor: middle; dominant-baseline: middle; }
    .title {font-family: Arial; font-size: 16px; font-weight: bold; text-anchor: middle; }
    .highlight-text {font-family: Arial; font-size: 15px; font-weight: bold; fill: #c0392b; text-anchor: middle; }
    .note {font-family: Arial; font-size: 12px; fill: #555; text-anchor: middle; }
    .small {font-size: 12px; }
    .comment {font-family: Arial; font-size: 13px; fill: #2980b9; text-anchor: middle; font-style: italic; }
    .red-label {font-family: Arial; font-size: 14px; fill: #e74c3c; text-anchor: middle; font-weight: bold; }
  </style>
  
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5"
      markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#666"/>
    </marker>
    <marker id="redarrow" viewBox="0 0 10 10" refX="9" refY="5"
      markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#e74c3c"/>
    </marker>
    <marker id="goldarrow" viewBox="0 0 10 10" refX="9" refY="5"
      markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#d4ac0d"/>
    </marker>
  </defs>
  
  <rect class="bg" x="0" y="0" width="1800" height="2400" />
  
  <!-- 标题 - 确保居中 -->
  <text x="600" y="50" font-family="Arial" font-size="24" font-weight="bold" text-anchor="middle">Vision Transformer 变化检测网络架构 (改进版)</text>
  <text x="600" y="80" font-family="Arial" font-size="18" fill="#e74c3c" text-anchor="middle">先上采样，再差异计算</text>
  
  <!-- 输入图像 -->
  <rect class="input" x="150" y="120" width="180" height="70" />
  <text class="title" x="240" y="145">输入图像 A (t1)</text>
  <text class="label" x="240" y="170">[B, 3, 256, 256]</text>
  
  <rect class="input" x="800" y="120" width="180" height="70" />
  <text class="title" x="890" y="145">输入图像 B (t2)</text>
  <text class="label" x="890" y="170">[B, 3, 256, 256]</text>
  
  <!-- 尺寸调整 -->
  <rect class="box" x="150" y="230" width="180" height="70" />
  <text class="title" x="240" y="255">尺寸调整</text>
  <text class="label" x="240" y="280">[B, 3, 224, 224]</text>
  
  <rect class="box" x="800" y="230" width="180" height="70" />
  <text class="title" x="890" y="255">尺寸调整</text>
  <text class="label" x="890" y="280">[B, 3, 224, 224]</text>
  
  <!-- ViT特征提取 -->
  <rect class="feature" x="150" y="340" width="180" height="70" />
  <text class="title" x="240" y="365">ViT 特征提取</text>
  <text class="label" x="240" y="395">[B, 196, 768]</text>
  
  <rect class="feature" x="800" y="340" width="180" height="70" />
  <text class="title" x="890" y="365">ViT 特征提取</text>
  <text class="label" x="890" y="395">[B, 196, 768]</text>
  
  <!-- Memory容器 -->
  <rect class="mem" x="390" y="450" width="400" height="150" />
  <text class="title" x="590" y="475">Memory (用于交叉注意力)</text>
  
  <!-- 特征合并 -->
  <rect class="box" x="455" y="500" width="270" height="70" />
  <text class="title" x="590" y="525">特征合并 (Cat)</text>
  <text class="label" x="590" y="550">[B, 392, 768]</text>
  
  <!-- 稀疏注意力编码器 -->
  <rect class="attn" x="455" y="630" width="270" height="80" />
  <text class="title" x="590" y="655">稀疏Transformer编码器</text>
  <text class="label" x="590" y="680">稀疏度: 0.1</text>
  <text class="label" x="590" y="700">[B, 392, 768]</text>
  
  <!-- 特征拆分 -->
  <rect class="box" x="455" y="740" width="270" height="60" />
  <text class="title" x="590" y="770">特征拆分 (Chunk)</text>
  
  <!-- Transformer解码器 -->
  <rect class="attn" x="150" y="830" width="180" height="80" />
  <text class="title" x="240" y="855">Transformer解码器</text>
  <text class="label" x="240" y="880">使用交叉注意力</text>
  <text class="label" x="240" y="900">[B, 196, 768]</text>
  
  <rect class="attn" x="800" y="830" width="180" height="80" />
  <text class="title" x="890" y="855">Transformer解码器</text>
  <text class="label" x="890" y="880">使用交叉注意力</text>
  <text class="label" x="890" y="900">[B, 196, 768]</text>
  
  <!-- 特征重塑为空间特征图 -->
  <rect class="box" x="150" y="950" width="180" height="70" />
  <text class="title" x="240" y="975">特征重塑</text>
  <text class="label" x="240" y="1000">[B, 768, 14, 14]</text>
  
  <rect class="box" x="800" y="950" width="180" height="70" />
  <text class="title" x="890" y="975">特征重塑</text>
  <text class="label" x="890" y="1000">[B, 768, 14, 14]</text>
  
  <!-- 渐进式上采样区域-图片A -->
  <rect class="highlight" x="100" y="1060" width="300" height="460" rx="10" />
  <text class="highlight-text" x="250" y="1085">渐进式上采样A</text>
  
  <!-- 渐进式上采样区域-图片B -->
  <rect class="highlight" x="750" y="1060" width="300" height="460" rx="10" />
  <text class="highlight-text" x="900" y="1085">渐进式上采样B</text>
  
  <!-- 阶段1：14x14 -> 28x28 (图片A) -->
  <rect class="process" x="140" y="1120" width="220" height="60" />
  <text class="title" x="250" y="1140">阶段1 (14x14→28x28)</text>
  <text class="label" x="250" y="1160">[B, 768, 28, 28]</text>
  
  <!-- 阶段1：14x14 -> 28x28 (图片B) -->
  <rect class="process" x="790" y="1120" width="220" height="60" />
  <text class="title" x="900" y="1140">阶段1 (14x14→28x28)</text>
  <text class="label" x="900" y="1160">[B, 768, 28, 28]</text>
  
  <!-- 阶段2：28x28 -> 56x56 (图片A) -->
  <rect class="process" x="140" y="1210" width="220" height="60" />
  <text class="title" x="250" y="1230">阶段2 (28x28→56x56)</text>
  <text class="label" x="250" y="1250">[B, 384, 56, 56]</text>
  
  <!-- 阶段2：28x28 -> 56x56 (图片B) -->
  <rect class="process" x="790" y="1210" width="220" height="60" />
  <text class="title" x="900" y="1230">阶段2 (28x28→56x56)</text>
  <text class="label" x="900" y="1250">[B, 384, 56, 56]</text>
  
  <!-- 阶段3：56x56 -> 112x112 (图片A) -->
  <rect class="process" x="140" y="1300" width="220" height="60" />
  <text class="title" x="250" y="1320">阶段3 (56x56→112x112)</text>
  <text class="label" x="250" y="1340">[B, 192, 112, 112]</text>
  
  <!-- 阶段3：56x56 -> 112x112 (图片B) -->
  <rect class="process" x="790" y="1300" width="220" height="60" />
  <text class="title" x="900" y="1320">阶段3 (56x56→112x112)</text>
  <text class="label" x="900" y="1340">[B, 192, 112, 112]</text>
  
  <!-- 阶段4：112x112 -> 224x224 (图片A) -->
  <rect class="process" x="140" y="1390" width="220" height="60" />
  <text class="title" x="250" y="1410">阶段4 (112x112→224x224)</text>
  <text class="label" x="250" y="1430">[B, 96, 224, 224]</text>
  
  <!-- 阶段4：112x112 -> 224x224 (图片B) -->
  <rect class="process" x="790" y="1390" width="220" height="60" />
  <text class="title" x="900" y="1410">阶段4 (112x112→224x224)</text>
  <text class="label" x="900" y="1430">[B, 96, 224, 224]</text>
  
  <!-- 阶段5：224x224 -> 256x256 (图片A) -->
  <rect class="process" x="140" y="1480" width="220" height="60" />
  <text class="title" x="250" y="1500">阶段5 (224x224→256x256)</text>
  <text class="label" x="250" y="1520">[B, 48, 256, 256]</text>
  
  <!-- 阶段5：224x224 -> 256x256 (图片B) -->
  <rect class="process" x="790" y="1480" width="220" height="60" />
  <text class="title" x="900" y="1500">阶段5 (224x224→256x256)</text>
  <text class="label" x="900" y="1520">[B, 48, 256, 256]</text>
  
  <!-- 变化检测核心计算 - 高亮显示 -->
  <rect class="highlight" x="390" y="1600" width="400" height="150" />
  <text class="highlight-text" x="590" y="1625">变化检测核心计算</text>
  
  <!-- 差异计算部分 - 突出显示 -->
  <rect class="diff" x="455" y="1650" width="270" height="80" />
  <text class="title" x="590" y="1670">差异计算 &amp; 稀疏化</text>
  <text class="note" x="590" y="1690">diff = |featA - featB|</text>
  <text class="note" x="590" y="1710">mask = diff &lt;= threshold</text>
  <text class="label" x="590" y="1730">[B, 48, 256, 256]</text>
  
  <!-- 变化检测图 -->
  <rect class="box" x="455" y="1780" width="270" height="70" />
  <text class="title" x="590" y="1805">变化检测图</text>
  <text class="note" x="590" y="1825">初步变化特征图</text>
  <text class="label" x="590" y="1845">[B, 48, 256, 256]</text>
  
  <!-- 边缘检测模块 - 作为辅助分支 -->
  <rect class="attn" x="800" y="1780" width="270" height="70" />
  <text class="title" x="935" y="1805">边缘检测模块</text>
  <text class="note" x="935" y="1825">从变化图中提取边缘特征</text>
  <text class="label" x="935" y="1845">[B, 2, 256, 256]</text>
  
  <!-- 维度转换模块 - 先进行维度转换 -->
  <rect class="box" x="455" y="1920" width="270" height="70" />
  <text class="title" x="590" y="1945">维度转换</text>
  <text class="note" x="590" y="1965">48通道 → 2通道(前景/背景)</text>
  <text class="note" x="590" y="1985">下采样</text>
  <text class="label" x="590" y="2005">[B, 2, 256, 256]</text>
  
  <!-- 边缘特征融合模块 - 在维度转换后融合 -->
  <rect class="fusion" x="455" y="2050" width="270" height="70" />
  <text class="title" x="590" y="2075">边缘特征融合</text>
  <text class="note" x="590" y="2095">增强变化边界精度</text>
  <text class="label" x="590" y="2115">[B, 2, 256, 256]</text>
  
  <!-- 输出层 -->
  <rect class="output" x="455" y="2170" width="270" height="70" />
  <text class="title" x="590" y="2195">输出层</text>
  <text class="note" x="590" y="2215">Softmax激活</text>
  <text class="label" x="590" y="2235">[B, 2, 256, 256]</text>
  
  <!-- 箭头连接 -->
  <!-- 输入处理流程 -->
  <path class="arrow" d="M 240 190 L 240 230" />
  <path class="arrow" d="M 890 190 L 890 230" />

  <path class="arrow" d="M 240 300 L 240 340" />
  <path class="arrow" d="M 890 300 L 890 340" />

  <!-- 特征提取到合并 -->
  <path class="arrow" d="M 240 410 L 240 525 L 455 525" />
  <path class="arrow" d="M 890 410 L 890 525 L 725 525" />

  <!-- 合并到编码器 -->
  <path class="arrow" d="M 590 570 L 590 630" />

  <!-- 编码器到拆分 -->
  <path class="arrow" d="M 590 710 L 590 740" />

  <!-- 拆分到解码器 -->
  <path class="arrow" d="M 455 770 L 240 770 L 240 830" />
  <path class="arrow" d="M 725 770 L 890 770 L 890 830" />

  <!-- Memory连接 - 修改为从外部连接 -->
  <path class="dashed-arrow" d="M 590 570 L 100 570 L 100 870 L 150 870" />
  <path class="dashed-arrow" d="M 590 570 L 1080 570 L 1080 870 L 980 870" />
  <text class="small" x="120" y="800">Memory作为Query的上下文</text>
  <text class="small" x="1080" y="800">Memory作为Query的上下文</text>

  <!-- 解码器到特征重塑 -->
  <path class="arrow" d="M 240 910 L 240 950" />
  <path class="arrow" d="M 890 910 L 890 950" />

  <!-- 特征重塑到渐进式上采样第一阶段 -->
  <path class="arrow" d="M 240 1020 L 240 1120" />
  <path class="arrow" d="M 890 1020 L 890 1120" />

  <!-- 渐进式上采样内部连接 -->
  <path class="arrow" d="M 250 1180 L 250 1210" />
  <path class="arrow" d="M 250 1270 L 250 1300" />
  <path class="arrow" d="M 250 1360 L 250 1390" />
  <path class="arrow" d="M 250 1450 L 250 1480" />

  <path class="arrow" d="M 900 1180 L 900 1210" />
  <path class="arrow" d="M 900 1270 L 900 1300" />
  <path class="arrow" d="M 900 1360 L 900 1390" />
  <path class="arrow" d="M 900 1450 L 900 1480" />

  <!-- 上采样到差异计算 -->
  <path class="arrow" d="M 250 1540 L 250 1690 L 455 1690" />
  <path class="arrow" d="M 900 1540 L 900 1690 L 725 1690" />

  <!-- 差异计算到变化检测图 -->
  <path class="arrow" d="M 590 1730 L 590 1780" />
  
  <!-- 变化检测图到边缘检测模块 -->
  <path class="arrow" d="M 725 1815 L 800 1815" />
  
  <!-- 变化检测图到维度转换 -->
  <path class="arrow" d="M 590 1850 L 590 1920" />
  
  <!-- 维度转换到边缘特征融合 -->
  <path class="arrow" d="M 590 2005 L 590 2050" />
  
  <!-- 边缘检测模块到边缘特征融合 -->
  <path class="arrow" d="M 935 1850 L 935 2085 L 725 2085" />
  
  <!-- 边缘特征融合到输出层 -->
  <path class="arrow" d="M 590 2120 L 590 2170" />
  
  <!-- 边缘特征融合标注 -->
  <text class="small" x="830" y="2060">将边缘特征与已转换的2通道变化图融合</text>
  

  
  <!-- 注释 -->
  <text class="comment" x="590" y="2350">先上采样再计算差异保留空间结构，通过边缘增强提高边界精度</text>
</svg> 